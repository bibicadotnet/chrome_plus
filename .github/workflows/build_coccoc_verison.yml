name: Build_CocCoc_Verison

on:
  push:
    paths-ignore:
      - ".clang-format"
      - ".gitignore"
      - "*.md"
      - "LICENSE"
      - "setdll/**"
      - ".github/ISSUE_TEMPLATE/**"
      - ".github/workflows/delete_old_workflow_runs.yml"
      - ".github/workflows/genReleaseNote.sh"
  workflow_dispatch:
  schedule:
    # Ch·∫°y v√†o 2h s√°ng theo gi·ªù Vi·ªát Nam (UTC+7)
    # 2h s√°ng VN = 19h t·ªëi UTC ng√†y h√¥m tr∆∞·ªõc (2 - 7 = -5, +24 = 19)
    - cron: '0 19 * * *'

permissions:
  contents: write
  packages: write
  id-token: write
  attestations: write

jobs:
  sync_fork:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check_release.outputs.has_changes }}
      upstream_version: ${{ steps.check_release.outputs.upstream_version }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get upstream repository info
        id: upstream
        run: |
          # L·∫•y th√¥ng tin upstream t·ª´ fork
          UPSTREAM_REPO=$(gh api repos/${{ github.repository }} --jq '.parent.full_name // empty')
          
          if [ -z "$UPSTREAM_REPO" ]; then
            echo "‚ö†Ô∏è This is not a fork or upstream not found"
            echo "upstream_repo=" >> $GITHUB_OUTPUT
            echo "is_fork=false" >> $GITHUB_OUTPUT
          else
            echo "upstream_repo=$UPSTREAM_REPO" >> $GITHUB_OUTPUT
            echo "is_fork=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Upstream repository: $UPSTREAM_REPO"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check upstream latest release
        id: check_release
        run: |
          # N·∫øu kh√¥ng ph·∫£i schedule (manual trigger ho·∫∑c push) ‚Üí lu√¥n build
          if [ "${{ github.event_name }}" != "schedule" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "upstream_version=manual" >> $GITHUB_OUTPUT
            echo "‚úÖ Manual trigger or push event, will proceed with build"
            exit 0
          fi
          
          # N·∫øu l√† schedule ‚Üí ki·ªÉm tra release upstream
          if [ "${{ steps.upstream.outputs.is_fork }}" == "true" ]; then
            # L·∫•y release m·ªõi nh·∫•t c·ªßa upstream
            UPSTREAM_VERSION=$(gh api repos/${{ steps.upstream.outputs.upstream_repo }}/releases/latest --jq '.tag_name // empty' 2>/dev/null || echo "")
            
            if [ -z "$UPSTREAM_VERSION" ]; then
              echo "‚ö†Ô∏è No upstream release found, skipping build"
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "upstream_version=none" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            echo "upstream_version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
            echo "üì¶ Upstream latest release: $UPSTREAM_VERSION"
            
            # L·∫•y tag m·ªõi nh·∫•t c·ªßa fork hi·ªán t·∫°i
            CURRENT_TAG=$(git describe --tags $(git rev-list --tags --max-count=1) 2>/dev/null || echo "none")
            echo "üìå Current tag: $CURRENT_TAG"
            
            # So s√°nh version
            if [ "$CURRENT_TAG" == "$UPSTREAM_VERSION" ]; then
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "‚è≠Ô∏è Already up to date with upstream release $UPSTREAM_VERSION, skipping build"
            else
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "‚úÖ New upstream release detected: $CURRENT_TAG ‚Üí $UPSTREAM_VERSION, will build"
            fi
          else
            # Kh√¥ng ph·∫£i fork ‚Üí ki·ªÉm tra commit g·∫ßn ƒë√¢y
            RECENT_COMMITS=$(git log --since="1 day ago" --oneline | wc -l)
            if [ "$RECENT_COMMITS" -gt 0 ]; then
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "upstream_version=local" >> $GITHUB_OUTPUT
              echo "‚úÖ Recent commits found, will proceed with build"
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "upstream_version=none" >> $GITHUB_OUTPUT
              echo "‚è≠Ô∏è No recent commits, skipping build"
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync with upstream release
        if: steps.upstream.outputs.is_fork == 'true' && steps.check_release.outputs.has_changes == 'true' && github.event_name == 'schedule'
        run: |
          echo "üîÑ Syncing with upstream release: ${{ steps.check_release.outputs.upstream_version }}"
          
          # C·∫•u h√¨nh git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Th√™m upstream remote
          git remote add upstream https://github.com/${{ steps.upstream.outputs.upstream_repo }}.git
          git fetch upstream --tags
          
          # Merge upstream/main
          git merge upstream/main --no-edit || {
            echo "‚ùå Merge conflict detected, aborting sync"
            git merge --abort
            exit 1
          }
          
          # Push changes
          git push origin main
          echo "‚úÖ Synced with upstream successfully"

      - name: Sync Summary
        if: always()
        run: |
          echo "## üîÑ Upstream Release Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(TZ='Asia/Ho_Chi_Minh' date '+%d/%m/%Y %H:%M:%S') (Vietnam Time)" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.upstream.outputs.is_fork }}" == "true" ]; then
            echo "**Upstream:** ${{ steps.upstream.outputs.upstream_repo }}" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ github.event_name }}" == "schedule" ]; then
              CURRENT_TAG=$(git describe --tags $(git rev-list --tags --max-count=1) 2>/dev/null || echo "none")
              echo "**Current Tag:** $CURRENT_TAG" >> $GITHUB_STEP_SUMMARY
              echo "**Upstream Release:** ${{ steps.check_release.outputs.upstream_version }}" >> $GITHUB_STEP_SUMMARY
              
              if [ "${{ steps.check_release.outputs.has_changes }}" == "true" ]; then
                echo "**Status:** ‚úÖ New upstream release detected, synced and will build" >> $GITHUB_STEP_SUMMARY
              else
                echo "**Status:** ‚ÑπÔ∏è Already up to date with upstream release" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "**Status:** ‚úÖ Manual/Push trigger" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "**Status:** ‚ÑπÔ∏è Not a fork, no upstream check needed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_release.outputs.has_changes }}" == "true" ]; then
            echo "**Build Decision:** ‚úÖ Will proceed with build and release" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Build Decision:** ‚è≠Ô∏è No new release, build skipped" >> $GITHUB_STEP_SUMMARY
          fi

  build:
    needs: sync_fork
    if: needs.sync_fork.outputs.has_changes == 'true'
    strategy:
      matrix:
        include:
          - name: build_x86
            arch: x86
          - name: build_x64
            arch: x64
          - name: build_arm64
            arch: arm64

    name: ${{ matrix.name }}
    runs-on: windows-2025

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v6
        with:
          submodules: 'true'
          fetch-depth: 0

      - name: Get Vietnam Date Version
        shell: bash
        run: |
          # L·∫•y ng√†y gi·ªù UTC v√† chuy·ªÉn sang m√∫i gi·ªù Vi·ªát Nam (UTC+7)
          VERSION=$(TZ='Asia/Ho_Chi_Minh' date +%d.%m.%Y)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Building version: $VERSION"

      - name: Update version.h
        shell: bash
        run: |
          # T√°ch version th√†nh ng√†y, th√°ng, nƒÉm
          IFS='.' read -r DAY MONTH YEAR <<< "${{ env.VERSION }}"
          
          # C·∫≠p nh·∫≠t version.h v·ªõi ng√†y th√°ng nƒÉm
          sed -i 's/#define RELEASE_VER_MAIN .*/#define RELEASE_VER_MAIN '"$DAY"'/' src/version.h
          sed -i 's/#define RELEASE_VER_SUB .*/#define RELEASE_VER_SUB '"$MONTH"'/' src/version.h
          sed -i 's/#define RELEASE_VER_FIX .*/#define RELEASE_VER_FIX '"$YEAR"'/' src/version.h

      - name: Personalize for C·ªëc C·ªëc Portable Debloat
        shell: bash
        run: |
          sed -i 's/VALUE "FileDescription", "Chrome++ Next"/VALUE "FileDescription", "C·ªëc C·ªëc Portable Debloat"/g' src/chrome++.rc
          sed -i 's|https://github.com/Bush2021/chrome_plus">Chrome++ Next</a>|https://coccoc.bibica.net">C·ªëc C·ªëc Portable Debloat</a>|g' src/pakpatch.cc

      - name: Set CLANG_BIN
        shell: bash
        run: |
          CLANG_BIN=$(dirname "$(where clang-cl | head -n 1)")
          echo "CLANG_BIN=$CLANG_BIN" >> $GITHUB_ENV

      - name: Setup MSVC Developer Command Prompt
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch }}

      - name: Setup Xmake
        uses: xmake-io/github-action-setup-xmake@v1
        with:
          xmake-version: '3.0.5'

      - name: Configure Xmake
        run: xmake f -a ${{ matrix.arch }} --toolchain=clang-cl --bin="${{ env.CLANG_BIN }}" --yes

      - name: Build Chrome++
        run: xmake

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: version-${{ matrix.arch }}-${{ env.VERSION }}
          path: build/release/*

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get Vietnam Date Version
        run: |
          VERSION=$(TZ='Asia/Ho_Chi_Minh' date +%d.%m.%Y)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Creating release for version: $VERSION"

      - name: Get Last Tag
        run: |
          LAST_TAG=$(git describe --tags $(git rev-list --tags --max-count=1) 2>/dev/null || echo "01.01.2025")
          echo "LAST_TAG=$LAST_TAG" >> $GITHUB_ENV
          echo "Last tag: $LAST_TAG"

      - name: Create and Push Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Ki·ªÉm tra xem tag ƒë√£ t·ªìn t·∫°i ch∆∞a
          if git rev-parse "${{ env.VERSION }}" >/dev/null 2>&1; then
            echo "Tag ${{ env.VERSION }} already exists, deleting old tag..."
            git tag -d "${{ env.VERSION }}" || true
            git push origin :refs/tags/${{ env.VERSION }} || true
          fi
          
          git tag -a "${{ env.VERSION }}" -m "Release ${{ env.VERSION }}"
          git push origin "${{ env.VERSION }}"

      - name: Generate Release Notes
        run: |
          if [ -f .github/workflows/genReleaseNote.sh ]; then
            chmod +x .github/workflows/genReleaseNote.sh
            .github/workflows/genReleaseNote.sh -v ${{ env.LAST_TAG }}...${{ env.VERSION }} || echo "Failed to generate release notes"
          fi
          
          # T·∫°o release notes m·∫∑c ƒë·ªãnh n·∫øu script kh√¥ng t·ªìn t·∫°i ho·∫∑c th·∫•t b·∫°i
          if [ ! -f release.md ]; then
            cat > release.md << EOF
          # Release ${{ env.VERSION }}
          
          ## Build Information
          - Version: ${{ env.VERSION }}
          - Build Date: $(TZ='Asia/Ho_Chi_Minh' date '+%d/%m/%Y %H:%M:%S') (Vietnam Time)
          - Previous Version: ${{ env.LAST_TAG }}
          
          ## Changes
          - Auto-generated release from build workflow
          
          ## Download
          Choose the appropriate package for your system:
          - **Chrome++_v${{ env.VERSION }}_x86_x64_arm64.7z**: Main package with all architectures
          - **setdll.7z**: SetDLL package with version.dll files
          EOF
          fi

      - name: Get SetDll Latest Release
        id: setdll
        continue-on-error: true
        run: |
          RELEASE_INFO=$(gh api repos/Bush2021/setdll/releases/latest 2>/dev/null || echo '{}')
          DOWNLOAD_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[0].browser_download_url // empty')
          
          if [ -n "$DOWNLOAD_URL" ]; then
            echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
            echo "SetDLL URL found: $DOWNLOAD_URL"
          else
            echo "download_url=" >> $GITHUB_OUTPUT
            echo "SetDLL release not found, will skip setdll package"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Build Artifacts
        uses: actions/download-artifact@v6
        with:
          path: build_artifacts

      - name: List Downloaded Artifacts
        run: |
          echo "=== Downloaded Artifacts ==="
          ls -laR build_artifacts/

      - name: Package All Artifacts
        run: |
          # T·∫°o c·∫•u tr√∫c th∆∞ m·ª•c
          mkdir -p artifacts/x86/{App,Data,Cache}
          mkdir -p artifacts/x64/{App,Data,Cache}
          mkdir -p artifacts/arm64/{App,Data,Cache}
          
          # Copy artifacts
          echo "Copying x86 artifacts..."
          cp -r build_artifacts/version-x86-${{ env.VERSION }}/* artifacts/x86/App/
          
          echo "Copying x64 artifacts..."
          cp -r build_artifacts/version-x64-${{ env.VERSION }}/* artifacts/x64/App/
          
          echo "Copying arm64 artifacts..."
          cp -r build_artifacts/version-arm64-${{ env.VERSION }}/* artifacts/arm64/App/
          
          # Copy config file n·∫øu t·ªìn t·∫°i
          if [ -f src/chrome++.ini ]; then
            cp src/chrome++.ini artifacts/x86/App/
            cp src/chrome++.ini artifacts/x64/App/
            cp src/chrome++.ini artifacts/arm64/App/
          fi
          
          # T·∫°o archive
          cd artifacts
          7z a -mx=9 -m0=lzma2 -mmt=on ../Chrome++_v${{ env.VERSION }}_x86_x64_arm64.7z *
          cd ..
          
          echo "Package created successfully"
          ls -lh Chrome++_v${{ env.VERSION }}_x86_x64_arm64.7z

      - name: Package SetDll
        if: steps.setdll.outputs.download_url != ''
        continue-on-error: true
        run: |
          mkdir -p setdll_package_contents
          
          echo "Downloading SetDLL..."
          wget -O setdll_latest.7z ${{ steps.setdll.outputs.download_url }}
          7z x setdll_latest.7z -o./setdll_package_contents
          rm setdll_latest.7z
          
          echo "Copying DLL files..."
          cp ./build_artifacts/version-x86-${{ env.VERSION }}/version.dll ./setdll_package_contents/version-x86.dll
          cp ./build_artifacts/version-x64-${{ env.VERSION }}/version.dll ./setdll_package_contents/version-x64.dll
          cp ./build_artifacts/version-arm64-${{ env.VERSION }}/version.dll ./setdll_package_contents/version-arm64.dll
          
          if [ -f ./src/chrome++.ini ]; then
            cp ./src/chrome++.ini ./setdll_package_contents/chrome++.ini
          fi
          
          cd setdll_package_contents
          echo "Contents before packaging:"
          ls -Al
          7z a -mx=9 -ms=on -m0=lzma2 -mmt=on ../setdll.7z *
          cd ..
          
          echo "SetDLL package created successfully"
          ls -lh setdll.7z

      - name: Attest Release Packages
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: |
            Chrome++_v${{ env.VERSION }}_x86_x64_arm64.7z
            setdll.7z

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            Chrome++_v${{ env.VERSION }}_x86_x64_arm64.7z
            setdll.7z
          body_path: release.md
          tag_name: ${{ env.VERSION }}
          name: Release ${{ env.VERSION }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "## üéâ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Date:** $(TZ='Asia/Ho_Chi_Minh' date '+%d/%m/%Y %H:%M:%S') (Vietnam Time)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Packages Released:" >> $GITHUB_STEP_SUMMARY
          echo "- Chrome++_v${{ env.VERSION }}_x86_x64_arm64.7z" >> $GITHUB_STEP_SUMMARY
          if [ -f setdll.7z ]; then
            echo "- setdll.7z" >> $GITHUB_STEP_SUMMARY
          fi
